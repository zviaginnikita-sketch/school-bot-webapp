<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding-bottom: 80px; }
        
        /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å */
        #status-bar {
            background: #333; color: #fff; padding: 8px; font-size: 11px; 
            text-align: center; word-break: break-all;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-btn { flex: 1; text-align: center; color: #8e8e93; font-size: 12px; cursor: pointer; }
        .nav-btn.active { color: #007aff; font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 4px; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .page { display: none; padding: 16px; }
        .page.active { display: block; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .sch-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .day-header { font-weight: bold; font-size: 18px; color: #007aff; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .week-toggle { display: flex; background: #e0e0e0; border-radius: 8px; margin-bottom: 15px; }
        .wt-btn { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .wt-btn.active { background: #fff; font-weight: bold; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button.main { width: 100%; padding: 14px; background: #007aff; color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–±–µ–∑ !important) */
        .hidden-tab { display: none; }
    </style>
</head>
<body>

    <!-- –°–¢–ê–¢–£–° (–î–ª—è –æ—Ç–ª–∞–¥–∫–∏) -->
    <div id="status-bar">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
    <div id="page-view" class="page active">
        <div class="week-toggle">
            <div class="wt-btn active" id="btn-odd" onclick="setWeek('odd')">–ù–µ—á–µ—Ç–Ω–∞—è</div>
            <div class="wt-btn" id="btn-even" onclick="setWeek('even')">–ß–µ—Ç–Ω–∞—è</div>
        </div>
        <div id="schedule-list">
            <div style="text-align: center; padding: 20px; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –î–û–ë–ê–í–ò–¢–¨ –î–ó -->
    <div id="page-add" class="page">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –î–ó</h3>
        <input type="date" id="hw-date">
        <select id="hw-pair">
            <option value="1">1 –ø–∞—Ä–∞</option><option value="2">2 –ø–∞—Ä–∞</option>
            <option value="3">3 –ø–∞—Ä–∞</option><option value="4">4 –ø–∞—Ä–∞</option><option value="5">5 –ø–∞—Ä–∞</option>
        </select>
        <input type="text" id="hw-subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <textarea id="hw-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="hw-photo" style="width: auto; margin: 0;">
            <span>üì∑ –§–æ—Ç–æ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–µ)</span>
        </label>
        <button class="main" onclick="sendHomework()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ê–î–ú–ò–ù (–°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="page-admin" class="page">
        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
        <select id="adm-day">
            <option>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option>–í—Ç–æ—Ä–Ω–∏–∫</option><option>–°—Ä–µ–¥–∞</option>
            <option>–ß–µ—Ç–≤–µ—Ä–≥</option><option>–ü—è—Ç–Ω–∏—Ü–∞</option>
        </select>
        <select id="adm-week"><option value="odd">–ù–µ—á–µ—Ç–Ω–∞—è</option><option value="even">–ß–µ—Ç–Ω–∞—è</option></select>
        <textarea id="adm-text" rows="10" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å—é–¥–∞..."></textarea>
        <button class="main" onclick="sendAdmin()">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É</button>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="go('view', this)"><span class="nav-icon">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="nav-btn" onclick="go('add', this)"><span class="nav-icon">‚úçÔ∏è</span>–î/–ó</div>
        <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ —Å–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ style -->
        <div class="nav-btn" id="nav-admin" style="display: none;" onclick="go('admin', this)">
            <span class="nav-icon">‚öôÔ∏è</span>–ê–¥–º–∏–Ω
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- –í–ê–® ID ---
        const ADMIN_ID = 697543617; 

        // 1. –ü–†–û–í–ï–†–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        const statusBar = document.getElementById('status-bar');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –±–µ–∑ ?. –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        let userId = null;
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id;
        }

        if (!userId) {
            statusBar.innerText = "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram.";
            statusBar.style.background = "#d9534f";
        } else {
            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Ç–∏–ø–æ–≤ (—á–∏—Å–ª–æ vs —Å—Ç—Ä–æ–∫–∞)
            const isMatch = String(userId) === String(ADMIN_ID);
            
            statusBar.innerText = `–í–∞—à ID: ${userId} | –ê–¥–º–∏–Ω ID: ${ADMIN_ID} | –î–æ—Å—Ç—É–ø: ${isMatch ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢"}`;
            statusBar.style.background = isMatch ? "#5cb85c" : "#f0ad4e";

            if (isMatch) {
                // –ï—Å–ª–∏ —Å–æ–≤–ø–∞–ª–æ - –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º display
                document.getElementById('nav-admin').style.display = 'block';
            }
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª
        setTimeout(function() {
            statusBar.style.display = 'none';
        }, 8000);


        // 2. –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –ò–ó URL
        let dbData = { perm: {} };
        let currentWeek = 'odd';

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const rawData = urlParams.get('data');
            if (rawData) {
                dbData = JSON.parse(decodeURIComponent(rawData));
                renderSchedule();
            } else {
                document.getElementById('schedule-list').innerHTML = 
                    "<div style='text-align:center; padding:20px; color:red'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ /start</div>";
            }
        } catch (e) {
            console.error(e);
            document.getElementById('schedule-list').innerHTML = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + e.message;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã
        document.getElementById('hw-date').valueAsDate = new Date();

        // 3. –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
        function go(pageId, btn) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const pages = document.querySelectorAll('.page');
            for(let i=0; i<pages.length; i++) { pages[i].classList.remove('active'); }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            document.getElementById('page-' + pageId).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            const btns = document.querySelectorAll('.nav-btn');
            for(let i=0; i<btns.length; i++) { btns[i].classList.remove('active'); }
            if(btn) btn.classList.add('active');
        }

        function setWeek(type) {
            currentWeek = type;
            document.getElementById('btn-odd').className = type === 'odd' ? 'wt-btn active' : 'wt-btn';
            document.getElementById('btn-even').className = type === 'even' ? 'wt-btn active' : 'wt-btn';
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-list');
            if (!dbData.perm || Object.keys(dbData.perm).length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:20px'>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ.</div>";
                return;
            }
            
            container.innerHTML = "";
            const days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

            for (let i = 0; i < days.length; i++) {
                const day = days[i];
                const dayObj = dbData.perm[day];
                if (!dayObj) continue;

                let text = "";
                if (typeof dayObj === 'string') text = dayObj; 
                else text = dayObj[currentWeek] || "";

                if (!text) continue; 

                // –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
                const cleanText = text.replace(/<[^>]*>?/gm, '');

                const card = document.createElement('div');
                card.className = 'sch-card';
                card.innerHTML = `<div class="day-header">${day}</div><div style="white-space: pre-wrap; font-size: 14px;">${cleanText}</div>`;
                container.appendChild(card);
            }
        }

        function sendHomework() {
            const date = document.getElementById('hw-date').value;
            if(!date) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            
            const dObj = new Date(date);
            const d = String(dObj.getDate()).padStart(2, '0');
            const m = String(dObj.getMonth() + 1).padStart(2, '0');
            const y = dObj.getFullYear();
            const fmtDate = `${d}.${m}.${y}`;

            const data = {
                action: "add_homework",
                date: fmtDate,
                pair: document.getElementById('hw-pair').value,
                subject: document.getElementById('hw-subject').value,
                text: document.getElementById('hw-text').value,
                has_photo: document.getElementById('hw-photo').checked
            };
            tg.sendData(JSON.stringify(data));
        }

        function sendAdmin() {
            const data = {
                action: "edit_perm",
                day: document.getElementById('adm-day').value,
                week_type: document.getElementById('adm-week').value,
                text: document.getElementById('adm-text').value
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
