<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–Ω–µ–≤–Ω–∏–∫ (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding-bottom: 80px; }
        
        /* –ë–ª–æ–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ - –ö–†–ê–°–ù–´–ô –ï–°–õ–ò –û–®–ò–ë–ö–ê, –ó–ï–õ–ï–ù–´–ô –ï–°–õ–ò –û–ö */
        #diag-panel {
            background: #333; color: #fff; padding: 10px; font-size: 11px; 
            font-family: monospace; word-break: break-all; border-bottom: 2px solid #000;
        }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-btn { flex: 1; text-align: center; color: #8e8e93; font-size: 12px; cursor: pointer; }
        .nav-btn.active { color: #007aff; font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 4px; }

        .page { display: none; padding: 16px; }
        .page.active { display: block; }

        .sch-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .day-header { font-weight: bold; font-size: 18px; color: #007aff; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .week-toggle { display: flex; background: #e0e0e0; border-radius: 8px; margin-bottom: 15px; }
        .wt-btn { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .wt-btn.active { background: #fff; font-weight: bold; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button.main { width: 100%; padding: 14px; background: #007aff; color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

    <!-- –ü–ê–ù–ï–õ–¨ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò -->
    <div id="diag-panel">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
    <div id="page-view" class="page active">
        <div class="week-toggle">
            <div class="wt-btn active" id="btn-odd" onclick="setWeek('odd')">–ù–µ—á–µ—Ç–Ω–∞—è</div>
            <div class="wt-btn" id="btn-even" onclick="setWeek('even')">–ß–µ—Ç–Ω–∞—è</div>
        </div>
        <div id="schedule-list">
            <div style="text-align: center; padding: 20px; color: #888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –î–û–ë–ê–í–ò–¢–¨ –î–ó -->
    <div id="page-add" class="page">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –î–ó</h3>
        <input type="date" id="hw-date">
        <select id="hw-pair">
            <option value="1">1 –ø–∞—Ä–∞</option><option value="2">2 –ø–∞—Ä–∞</option>
            <option value="3">3 –ø–∞—Ä–∞</option><option value="4">4 –ø–∞—Ä–∞</option><option value="5">5 –ø–∞—Ä–∞</option>
        </select>
        <input type="text" id="hw-subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <textarea id="hw-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="hw-photo" style="width: auto; margin: 0;">
            <span>üì∑ –§–æ—Ç–æ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–µ)</span>
        </label>
        <button class="main" onclick="sendHomework()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ê–î–ú–ò–ù -->
    <div id="page-admin" class="page">
        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
        <select id="adm-day">
            <option>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option>–í—Ç–æ—Ä–Ω–∏–∫</option><option>–°—Ä–µ–¥–∞</option>
            <option>–ß–µ—Ç–≤–µ—Ä–≥</option><option>–ü—è—Ç–Ω–∏—Ü–∞</option>
        </select>
        <select id="adm-week"><option value="odd">–ù–µ—á–µ—Ç–Ω–∞—è</option><option value="even">–ß–µ—Ç–Ω–∞—è</option></select>
        <textarea id="adm-text" rows="10" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è..."></textarea>
        <button class="main" onclick="sendAdmin()">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É</button>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="go('view', this)"><span class="nav-icon">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="nav-btn" onclick="go('add', this)"><span class="nav-icon">‚úçÔ∏è</span>–î/–ó</div>
        <div class="nav-btn" id="nav-admin" style="display: none;" onclick="go('admin', this)">
            <span class="nav-icon">‚öôÔ∏è</span>–ê–¥–º–∏–Ω
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –í–ê–® ID
        const ADMIN_ID = 697543617; 

        // === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ===
        const diag = document.getElementById('diag-panel');
        let diagText = "";
        let hasError = false;

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –∏ –¥–∞–Ω–Ω—ã—Ö
        const fullUrl = window.location.href;
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');
        
        diagText += `URL Len: ${fullUrl.length} chars. `;
        if (!rawData) {
            diagText += "[–û–®–ò–ë–ö–ê: –ù–ï–¢ –î–ê–ù–ù–´–• –í –°–°–´–õ–ö–ï]. ";
            diagText += "–í—ã –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é? –ù–∞–∂–º–∏—Ç–µ –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É –≤ —á–∞—Ç–µ! ";
            hasError = true;
        } else {
            diagText += "[–î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å]. ";
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ User ID
        let userId = null;
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id;
            diagText += `ID: ${userId}. `;
        } else {
            diagText += "[–û–®–ò–ë–ö–ê: ID –ù–ï –ù–ê–ô–î–ï–ù]. –û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram? ";
            hasError = true;
        }

        // –í—ã–≤–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        diag.innerText = diagText;
        diag.style.background = hasError ? "#d9534f" : "#5cb85c";

        // === –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ê ===
        if (userId && String(userId) === String(ADMIN_ID)) {
            document.getElementById('nav-admin').style.display = 'block';
            diag.innerText += " (–í—ã –ê–¥–º–∏–Ω)";
        }

        // === –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• ===
        let dbData = { perm: {} };
        let currentWeek = 'odd';

        if (rawData) {
            try {
                dbData = JSON.parse(decodeURIComponent(rawData));
                renderSchedule();
            } catch (e) {
                document.getElementById('schedule-list').innerHTML = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: " + e.message;
            }
        } else {
             document.getElementById('schedule-list').innerHTML = 
                "<div style='padding:20px; text-align:center'><b>–ü—É—Å—Ç–æ.</b><br>1. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É /start<br>2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —á–∞—Ç–∞</div>";
        }

        // === –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
        document.getElementById('hw-date').valueAsDate = new Date();

        function go(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function setWeek(type) {
            currentWeek = type;
            document.getElementById('btn-odd').className = type === 'odd' ? 'wt-btn active' : 'wt-btn';
            document.getElementById('btn-even').className = type === 'even' ? 'wt-btn active' : 'wt-btn';
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-list');
            if (!dbData.perm || Object.keys(dbData.perm).length === 0) return;
            
            container.innerHTML = "";
            const days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

            days.forEach(day => {
                const dayObj = dbData.perm[day];
                if (!dayObj) return;

                let text = typeof dayObj === 'string' ? dayObj : (dayObj[currentWeek] || "");
                if (!text) return;

                // –£–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏
                text = text.replace(/<[^>]*>?/gm, '');

                const card = document.createElement('div');
                card.className = 'sch-card';
                card.innerHTML = `<div class="day-header">${day}</div><div style="white-space: pre-wrap; font-size: 14px;">${text}</div>`;
                container.appendChild(card);
            });
        }

        function sendHomework() {
            const date = document.getElementById('hw-date').value;
            if(!date) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            
            const dObj = new Date(date);
            const d = String(dObj.getDate()).padStart(2, '0');
            const m = String(dObj.getMonth() + 1).padStart(2, '0');
            const y = dObj.getFullYear();
            const fmtDate = `${d}.${m}.${y}`;

            const data = {
                action: "add_homework",
                date: fmtDate,
                pair: document.getElementById('hw-pair').value,
                subject: document.getElementById('hw-subject').value,
                text: document.getElementById('hw-text').value,
                has_photo: document.getElementById('hw-photo').checked
            };
            tg.sendData(JSON.stringify(data));
        }

        function sendAdmin() {
            const data = {
                action: "edit_perm",
                day: document.getElementById('adm-day').value,
                week_type: document.getElementById('adm-week').value,
                text: document.getElementById('adm-text').value
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
