<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–µ–±-–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-secondary-bg-color, #f0f2f5);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --accent-color: var(--tg-theme-button-color, #007aff);
        }
        body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 80px; }
        
        /* –¢–∞–±—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); border-top: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-btn { flex: 1; text-align: center; color: var(--hint-color); font-size: 12px; cursor: pointer; }
        .nav-btn.active { color: var(--accent-color); font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 4px; }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .page { display: none; padding: 16px; }
        .page.active { display: block; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
        .sch-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .day-header { font-weight: bold; font-size: 18px; color: var(--accent-color); margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .day-content { white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–µ–¥–µ–ª—å */
        .week-toggle {
            display: flex; background: #e0e0e0; border-radius: 8px; p-1; margin-bottom: 15px;
        }
        .wt-btn {
            flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px;
        }
        .wt-btn.active { background: var(--card-bg); font-weight: bold; shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* –§–æ—Ä–º—ã */
        input, select, textarea { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; 
            border: 1px solid #ddd; box-sizing: border-box; 
        }
        button.main { 
            width: 100%; padding: 14px; background: var(--accent-color); color: #fff; 
            border: none; border-radius: 10px; font-weight: bold; font-size: 16px; 
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ü–†–û–°–ú–û–¢–† –†–ê–°–ü–ò–°–ê–ù–ò–Ø -->
    <div id="page-view" class="page active">
        <div class="week-toggle">
            <div class="wt-btn active" id="btn-odd" onclick="setWeek('odd')">–ù–µ—á–µ—Ç–Ω–∞—è</div>
            <div class="wt-btn" id="btn-even" onclick="setWeek('even')">–ß–µ—Ç–Ω–∞—è</div>
        </div>
        <div id="schedule-list">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
            <div style="text-align: center; padding: 20px; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –î–û–ë–ê–í–ò–¢–¨ –î–û–ú–ê–®–ö–£ -->
    <div id="page-add" class="page">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –î–ó</h3>
        <input type="date" id="hw-date">
        <select id="hw-pair">
            <option value="1">1 –ø–∞—Ä–∞</option><option value="2">2 –ø–∞—Ä–∞</option>
            <option value="3">3 –ø–∞—Ä–∞</option><option value="4">4 –ø–∞—Ä–∞</option><option value="5">5 –ø–∞—Ä–∞</option>
        </select>
        <input type="text" id="hw-subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <textarea id="hw-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
        
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="hw-photo" style="width: auto; margin: 0;">
            <span>üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (–ø–æ—Ç–æ–º –≤ –±–æ—Ç–µ)</span>
        </label>

        <button class="main" onclick="sendHomework()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ê–î–ú–ò–ù -->
    <div id="page-admin" class="page">
        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä (–ê–¥–º–∏–Ω)</h3>
        <select id="adm-day">
            <option>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option>–í—Ç–æ—Ä–Ω–∏–∫</option><option>–°—Ä–µ–¥–∞</option>
            <option>–ß–µ—Ç–≤–µ—Ä–≥</option><option>–ü—è—Ç–Ω–∏—Ü–∞</option>
        </select>
        <select id="adm-week"><option value="odd">–ù–µ—á–µ—Ç–Ω–∞—è</option><option value="even">–ß–µ—Ç–Ω–∞—è</option></select>
        <textarea id="adm-text" rows="10"></textarea>
        <button class="main" onclick="sendAdmin()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="go('view', this)"><span class="nav-icon">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="nav-btn" onclick="go('add', this)"><span class="nav-icon">‚úçÔ∏è</span>–î/–ó</div>
        <div class="nav-btn hidden" id="nav-admin" onclick="go('admin', this)"><span class="nav-icon">‚öôÔ∏è</span>–ê–¥–º–∏–Ω</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const ADMIN_ID = 697543617;
        const user = tg.initDataUnsafe?.user;

        // –î–∞–Ω–Ω—ã–µ
        let dbData = { perm: {} };
        let currentWeek = 'odd';

        // 1. –ü–ê–†–°–ò–ù–ì –î–ê–ù–ù–´–• –ò–ó URL
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const rawData = urlParams.get('data');
            if (rawData) {
                dbData = JSON.parse(decodeURIComponent(rawData));
            } else {
                document.getElementById('schedule-list').innerHTML = 
                    "<p style='text-align:center'>–î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start</p>";
            }
        } catch (e) {
            console.error(e);
        }

        // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        if (user && String(user.id) === String(ADMIN_ID)) {
            document.getElementById('nav-admin').classList.remove('hidden');
        }
        document.getElementById('hw-date').valueAsDate = new Date();
        renderSchedule();

        // 3. –§–£–ù–ö–¶–ò–ò
        function go(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function setWeek(type) {
            currentWeek = type;
            document.getElementById('btn-odd').className = type === 'odd' ? 'wt-btn active' : 'wt-btn';
            document.getElementById('btn-even').className = type === 'even' ? 'wt-btn active' : 'wt-btn';
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-list');
            if (!dbData.perm || Object.keys(dbData.perm).length === 0) return;
            
            container.innerHTML = "";
            const days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

            days.forEach(day => {
                const dayObj = dbData.perm[day];
                if (!dayObj) return;

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
                let text = "";
                if (typeof dayObj === 'string') text = dayObj; // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                else text = dayObj[currentWeek] || "";

                if (!text) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –¥–Ω–∏

                // –û—á–∏—Å—Ç–∫–∞ HTML —Ç–µ–≥–æ–≤ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                // text = text.replace(/<b>/g, '').replace(/<\/b>/g, ''); 
                
                const card = document.createElement('div');
                card.className = 'sch-card';
                card.innerHTML = `<div class="day-header">${day}</div><div class="day-content">${text}</div>`;
                container.appendChild(card);
            });
        }

        function sendHomework() {
            const date = document.getElementById('hw-date').value;
            if(!date) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            
            // –§–æ—Ä–º–∞—Ç DD.MM.YYYY
            const dObj = new Date(date);
            const fmtDate = `${String(dObj.getDate()).padStart(2,'0')}.${String(dObj.getMonth()+1).padStart(2,'0')}.${dObj.getFullYear()}`;

            const data = {
                action: "add_homework",
                date: fmtDate,
                pair: document.getElementById('hw-pair').value,
                subject: document.getElementById('hw-subject').value,
                text: document.getElementById('hw-text').value,
                has_photo: document.getElementById('hw-photo').checked
            };
            tg.sendData(JSON.stringify(data));
        }

        function sendAdmin() {
            const data = {
                action: "edit_perm",
                day: document.getElementById('adm-day').value,
                week_type: document.getElementById('adm-week').value,
                text: document.getElementById('adm-text').value
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
