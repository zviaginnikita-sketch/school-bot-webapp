<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #000; margin: 0; padding-bottom: 80px; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff; border-top: 1px solid #ddd;
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-btn { flex: 1; text-align: center; color: #8e8e93; font-size: 12px; cursor: pointer; }
        .nav-btn.active { color: #007aff; font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 4px; }

        .page { display: none; padding: 16px; }
        .page.active { display: block; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .sch-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .day-header { font-weight: bold; font-size: 18px; color: #007aff; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .week-toggle { display: flex; background: #e0e0e0; border-radius: 8px; margin-bottom: 15px; }
        .wt-btn { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .wt-btn.active { background: #fff; font-weight: bold; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button.main { width: 100%; padding: 14px; background: #007aff; color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-bottom: 10px;}
        button.secondary { width: 100%; padding: 14px; background: #6c757d; color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }

        /* –ë–ª–æ–∫ –ø–∞—Ä–æ–ª—è */
        #admin-login { text-align: center; padding: 20px; background: #fff; border-radius: 12px; margin-top: 20px; }
        #admin-content { display: none; }
        .error-msg { color: red; font-size: 14px; display: none; margin-bottom: 10px; }

        /* –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω */
        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
    </style>
</head>
<body>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
    <div id="page-view" class="page active">
        <div class="week-toggle">
            <div class="wt-btn active" id="btn-odd" onclick="setWeek('odd')">–ù–µ—á–µ—Ç–Ω–∞—è</div>
            <div class="wt-btn" id="btn-even" onclick="setWeek('even')">–ß–µ—Ç–Ω–∞—è</div>
        </div>
        <div id="schedule-list">
            <!-- –°—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ -->
        </div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –î–û–ë–ê–í–ò–¢–¨ –î–ó -->
    <div id="page-add" class="page">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –î–ó</h3>
        <input type="date" id="hw-date">
        <select id="hw-pair">
            <option value="1">1 –ø–∞—Ä–∞</option><option value="2">2 –ø–∞—Ä–∞</option>
            <option value="3">3 –ø–∞—Ä–∞</option><option value="4">4 –ø–∞—Ä–∞</option><option value="5">5 –ø–∞—Ä–∞</option>
        </select>
        <input type="text" id="hw-subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <textarea id="hw-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è..."></textarea>
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="hw-photo" style="width: auto; margin: 0;">
            <span>üì∑ –§–æ—Ç–æ (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–µ)</span>
        </label>
        <button class="main" onclick="sendHomework()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ê–î–ú–ò–ù (–° –ü–ê–†–û–õ–ï–ú) -->
    <div id="page-admin" class="page">
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="admin-login">
            <h3>üîí –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</h3>
            <p style="font-size: 14px; color: #888;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</p>
            <input type="password" id="adm-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="text-align: center;">
            <div class="error-msg" id="pass-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
            <button class="main" onclick="checkPass()">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω–∞ (–°–∫—Ä—ã—Ç) -->
        <div id="admin-content">
            <h3>–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
            <select id="adm-day">
                <option>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option>–í—Ç–æ—Ä–Ω–∏–∫</option><option>–°—Ä–µ–¥–∞</option>
                <option>–ß–µ—Ç–≤–µ—Ä–≥</option><option>–ü—è—Ç–Ω–∏—Ü–∞</option>
            </select>
            <select id="adm-week"><option value="odd">–ù–µ—á–µ—Ç–Ω–∞—è</option><option value="even">–ß–µ—Ç–Ω–∞—è</option></select>
            <textarea id="adm-text" rows="10" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è..."></textarea>
            <button class="main" onclick="sendAdmin()">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É</button>
            <button class="secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="go('view', this)"><span class="nav-icon">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="nav-btn" onclick="go('add', this)"><span class="nav-icon">‚úçÔ∏è</span>–î/–ó</div>
        <div class="nav-btn" onclick="go('admin', this)"><span class="nav-icon">‚öôÔ∏è</span>–ê–¥–º–∏–Ω</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        const ADMIN_PASSWORD = "1234"; // <--- –ó–ê–î–ê–ô–¢–ï –ü–ê–†–û–õ–¨ –¢–£–¢

        // –î–∞–Ω–Ω—ã–µ
        let dbData = { perm: {} };
        let currentWeek = 'odd';

        // 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');

        if (rawData) {
            try {
                dbData = JSON.parse(decodeURIComponent(rawData));
                renderSchedule();
            } catch (e) {
                showEmptyState("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
            }
        } else {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é (–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)
            showEmptyState();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã
        document.getElementById('hw-date').valueAsDate = new Date();

        // === –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ===

        function showEmptyState(msg) {
            const container = document.getElementById('schedule-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 40px; margin-bottom: 20px;">üìÇ</div>
                    <p>${msg || "–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"}</p>
                    <p style="font-size: 13px; color: #999;">–ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–ª–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é,<br>–Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
                    <button class="main" onclick="requestData()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                </div>
            `;
        }

        function requestData() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ
            const data = { action: "request_schedule_link" };
            tg.sendData(JSON.stringify(data));
        }

        function go(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function setWeek(type) {
            currentWeek = type;
            document.getElementById('btn-odd').className = type === 'odd' ? 'wt-btn active' : 'wt-btn';
            document.getElementById('btn-even').className = type === 'even' ? 'wt-btn active' : 'wt-btn';
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-list');
            if (!dbData.perm || Object.keys(dbData.perm).length === 0) {
                container.innerHTML = "<div class='empty-state'>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ</div>";
                return;
            }
            
            container.innerHTML = "";
            const days = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

            days.forEach(day => {
                const dayObj = dbData.perm[day];
                if (!dayObj) return;

                let text = typeof dayObj === 'string' ? dayObj : (dayObj[currentWeek] || "");
                if (!text) return;

                // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤
                text = text.replace(/<[^>]*>?/gm, '');

                const card = document.createElement('div');
                card.className = 'sch-card';
                card.innerHTML = `<div class="day-header">${day}</div><div style="white-space: pre-wrap; font-size: 14px;">${text}</div>`;
                container.appendChild(card);
            });
        }

        // === –õ–û–ì–ò–ö–ê –ü–ê–†–û–õ–Ø ===
        function checkPass() {
            const input = document.getElementById('adm-pass').value;
            const err = document.getElementById('pass-error');
            
            if (input === ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                err.style.display = 'none';
            } else {
                err.style.display = 'block';
            }
        }

        function logout() {
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('adm-pass').value = "";
        }

        // === –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ===
        function sendHomework() {
            const date = document.getElementById('hw-date').value;
            if(!date) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            
            const dObj = new Date(date);
            const d = String(dObj.getDate()).padStart(2, '0');
            const m = String(dObj.getMonth() + 1).padStart(2, '0');
            const y = dObj.getFullYear();
            const fmtDate = `${d}.${m}.${y}`;

            const data = {
                action: "add_homework",
                date: fmtDate,
                pair: document.getElementById('hw-pair').value,
                subject: document.getElementById('hw-subject').value,
                text: document.getElementById('hw-text').value,
                has_photo: document.getElementById('hw-photo').checked
            };
            tg.sendData(JSON.stringify(data));
        }

        function sendAdmin() {
            const data = {
                action: "edit_perm",
                day: document.getElementById('adm-day').value,
                week_type: document.getElementById('adm-week').value,
                text: document.getElementById('adm-text').value
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–æ—Ç–∞ (Python)

–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ **¬´üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ¬ª**. –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫—É—Å–æ—á–µ–∫ –∫–æ–¥–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é `web_app_handler` –≤ —Ñ–∞–π–ª–µ `bot_main.py` (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é —Ü–µ–ª–∏–∫–æ–º).

```python
# –í–ù–£–¢–†–ò –§–£–ù–ö–¶–ò–ò web_app_handler:
        
        # ... (–∫–æ–¥ –¥–ª—è edit_perm –∏ add_homework) ...

        elif action == "request_schedule_link":
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –≤ –≤–µ–±–µ
            url = generate_webapp_url()
            kb = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üì• –û—Ç–∫—Ä—ã—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏", web_app=WebAppInfo(url=url))]
            ])
            await message.answer("–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:", reply_markup=kb)
